# 要求仕様書 - 実験ノート検索システム v2.0

## 1. プロジェクト概要

### 1.1 目的
実験ノートの効率的な検索・再利用を実現し、研究開発の生産性を向上させる。

### 1.2 対象ユーザー
- 研究者・実験担当者
- プロジェクトマネージャー
- チーム内の情報共有を必要とする全メンバー

### 1.3 前提システム
- **ベースシステム**: `/Users/nori8774/LangChain_v2`
- **コア技術**: LangChain + LangGraph + ChromaDB + Cohere Reranking

---

## 2. 機能要件

### 2.1 コア検索機能（既存）

#### FR-001: 多角的クエリ生成
- **概要**: ユーザーの検索意図を「ベテラン」「新人」「マネージャー」の3視点でクエリ化
- **入力**: 目的、材料、実験手法、重点指示（任意）
- **出力**: 3つの視点から生成された検索クエリ

#### FR-002: 材料名正規化
- **概要**: 表記揺れを統一して検索精度を向上
- **処理**: マスター辞書（YAML）による自動正規化
- **例**: "EtOH" → "エタノール"

#### FR-003: ベクトル検索 + Reranking
- **概要**: OpenAI EmbeddingsでベクトルDB検索、Cohere APIで再ランキング
- **パラメータ**: Embeddingモデル、LLMモデルをユーザー選択可能
- **出力**: 関連度の高い実験ノート上位10件

#### FR-004: 比較分析レポート生成
- **概要**: 検索結果から上位3件を比較分析
- **出力**: Markdown形式の詳細レポート

### 2.2 新機能

#### FR-101: プロンプト管理機能
- **要件**: ハードコードされたプロンプトをUI上で編集・保存
- **保存方式**: YAMLファイル（最大50件）
- **機能**:
  - プロンプトの作成・編集・削除
  - 名前・説明付きで保存
  - 過去のプロンプトの呼び出し
  - 初期設定へのリセット

#### FR-102: 検索結果コピー機能
- **要件**: 上位3件の材料・方法をワンクリックで検索条件に反映
- **動作**: コピーボタン → 入力欄に自動挿入
- **フォーマット**: Markdown形式を維持

#### FR-103: 検索履歴管理
- **要件**: 検索クエリと結果を履歴として保存・再利用
- **保存内容**:
  - 検索クエリ（目的・材料・方法・重点指示）
  - 検索日時
  - 上位10件のノートID + スコア
  - 使用したプロンプト名
- **表示**: テーブル形式、ソート・フィルタリング可能
- **再利用**: クリックで過去の検索を復元

#### FR-104: 実験ノート直接閲覧機能
- **要件**: ノートIDを入力して全文を表示
- **機能**:
  - セクション別表示（目的・材料・方法・結果）
  - 各セクションのコピーボタン
  - 検索条件への反映

#### FR-105: モデル選択UI
- **要件**: Embedding/LLMモデルをUI上で選択
- **選択肢**:
  - Embedding: text-embedding-3-small/large, ada-002
  - LLM: gpt-4o-mini/4o, gpt-4-turbo, gpt-3.5-turbo
- **説明**: 各モデルのコスト・性能・速度を表示

#### FR-106: RAG性能評価機能
- **要件**: 事前定義したテストケースで検索精度を測定
- **評価指標**: nDCG@10, Precision@K, Recall@10, MRR
- **テストケース管理**:
  - Excel/CSVからインポート
  - 手動作成・編集
  - 正解ランキングとの比較
- **結果表示**: グラフ、比較テーブル

#### FR-107: 新出単語抽出と正規化辞書管理
- **要件**: ノート取り込み時に未知の化学物質名を自動検出
- **判定支援**: LLMで類似単語を検索、表記揺れか新規物質かを判定
- **辞書更新**: ユーザー確認後に自動更新
- **管理UI**: 辞書の閲覧・編集・エクスポート/インポート

#### FR-108: ChromaDB管理機能 ⭐ 新規追加
- **要件**: Embeddingモデル変更時の互換性問題を防止
- **機能**:
  - 現在のEmbeddingモデル表示
  - モデル変更時の警告表示
  - ChromaDBリセット機能
  - 設定履歴の記録

---

## 3. 非機能要件

### 3.1 性能要件
- **NFR-001**: 検索レスポンス時間 < 5秒
- **NFR-002**: 新出単語抽出 < 10秒/ノート
- **NFR-003**: 増分DB更新（既存ノートスキップ）

### 3.2 セキュリティ要件
- **NFR-101**: APIキーはユーザーがブラウザで入力（localStorage保存）
- **NFR-102**: サーバー側でAPIキーを保存しない
- **NFR-103**: HTTPS通信のみ

### 3.3 ユーザビリティ要件
- **NFR-201**: 既存UIデザインとの統一性
- **NFR-202**: レスポンシブ対応（モバイル・タブレット）
- **NFR-203**: エラーメッセージの日本語化

### 3.4 運用要件
- **NFR-301**: Vercelでのフロントエンドデプロイ
- **NFR-302**: Railwayでのバックエンドデプロイ
- **NFR-303**: ローカルファイルシステムでのストレージ管理

---

## 4. 制約条件

### 4.1 技術制約
- Next.js 15 App Router使用
- Python 3.12+
- OpenAI API / Cohere API依存

### 4.2 データ制約
- **実験ノート**: Markdown形式
- **ベクトルDB**: ローカルChromatDB（永続化）
- **プロンプト保存上限**: 50件

### 4.3 コスト制約
- ユーザー自身のAPIキーを使用（コスト分散）

---

## 5. 成功指標（KPI）

### 5.1 機能完成度
- [ ] 全8機能（FR-001〜FR-108）が実装され動作する

### 5.2 検索精度
- [ ] nDCG@10 ≥ 0.8

### 5.3 ユーザビリティ
- [ ] チーム内利用率 ≥ 70%

### 5.4 パフォーマンス
- [ ] 検索レスポンス < 5秒
- [ ] ノート取り込み作業の自動化率 > 80%

---

## 6. リスクと対応策

| リスク | 影響 | 対応策 |
|--------|------|--------|
| Embeddingモデル変更時のDB互換性喪失 | 高 | ✅ FR-108で対応済み（警告+リセット機能） |
| APIコスト増大 | 中 | ユーザー個別のAPIキー使用 |
| 大量ノート時の検索速度低下 | 中 | インデックス最適化、ページネーション |
| ローカルストレージの永続化問題 | 高 | Railway常時起動サーバー使用 |

---

## 7. 用語集

| 用語 | 説明 |
|------|------|
| Embedding | テキストをベクトル表現に変換するモデル |
| Reranking | 検索結果を関連度順に並べ替える処理 |
| nDCG@10 | 上位10件の検索精度を測る評価指標 |
| 正規化 | 表記揺れを統一する処理 |
| 増分更新 | 既存データをスキップして新規データのみ処理 |

---

**作成日**: 2025-12-25
**最終更新**: 2025-12-25
**バージョン**: 2.0.0
