# 要求内容

## 概要

RAG検索の精度向上のため、単一の包括クエリではなく「材料軸」「方法軸」「総合軸」の3軸で分離検索を行い、加重スコアリングで最終ランキングを生成する機能を実装する。

## 背景

現在のクエリ生成方式では、目的・材料・方法・重点指示を総合した1つのクエリを生成している。この方式では以下の問題がある:

1. **包括的すぎる**: 「NaOH 10mL」「80rpm 5分撹拌」などの具体的な数値条件が他の情報に埋もれる
2. **材料/方法への特化が困難**: 実験ノートは材料の容量や方法の手順が重要だが、それぞれに特化した検索ができない
3. **ウエイト調整ができない**: チームによって材料重視/方法重視など検索の優先度が異なる

## 実装対象の機能

### 1. 3軸分離検索（バックエンド）

- **材料軸**: 材料情報（+ 条件付きで重点指示）をベースにクエリを生成して検索
- **方法軸**: 方法情報（+ 条件付きで重点指示）をベースにクエリを生成して検索
- **総合軸**: 目的+材料+方法+重点指示（現行方式）で検索

### 2. 重点指示の動的適用（バックエンド）

- LLMで重点指示を解析し、「材料関連」「方法関連」「両方」「該当なし」を判定
- 判定結果に応じて、材料軸・方法軸に重点指示を適用するかを決定
- 重点指示が空の場合は各軸の基本要素のみで検索

### 3. 加重スコアリング（バックエンド）

2つの統合方式を選択可能:
- **RRF (Reciprocal Rank Fusion)**: `score = Σ (weight_i / (k + rank_i))`
- **線形結合**: `score = α×材料スコア + β×方法スコア + γ×総合スコア`

### 4. リランキング位置の選択（バックエンド）

2つのリランキング方式を選択可能:
- **統合後リランク**: 各軸で検索 → スコア統合 → リランク
- **各軸後リランク**: 各軸で検索 → 各軸でリランク → スコア統合

### 5. プロンプト管理UIの拡張（フロントエンド）

現在のプロンプト:
- `query_generation`: 統合クエリ生成
- `compare`: 比較分析

変更後のプロンプト:
- `material_query_generation`: 材料軸クエリ生成 **新規**
- `method_query_generation`: 方法軸クエリ生成 **新規**
- `combined_query_generation`: 総合軸クエリ生成（現行`query_generation`を改名）
- `focus_classification`: 重点指示分類 **新規**
- `compare`: 比較分析（変更なし）

### 6. 評価機能の拡張（フロントエンド）

- **設定UI**: 3軸検索パラメータの設定（ウエイト、統合方式、リランク位置）
- **CSV出力**: 新しいカラム追加
  - 統合方式（RRF/線形結合）
  - 各軸ウエイト（材料/方法/総合）
  - リランク位置（per_axis/after_fusion）
  - リランク有効/無効
- **結果表示**: 各軸の検索結果を表示可能に

## 受け入れ条件

### 3軸分離検索
- [ ] 材料軸、方法軸、総合軸の3つの検索が実行される
- [ ] 各軸で独立した検索クエリが生成される
- [ ] 各軸の検索結果がスコア付きで取得できる

### 重点指示の動的適用
- [ ] 「NaOHの液量を変更して」→ 材料軸に適用される
- [ ] 「撹拌時間を短縮した」→ 方法軸に適用される
- [ ] 「NaOH濃度を上げて撹拌時間を延ばした」→ 両軸に適用される
- [ ] 重点指示が空の場合、各軸は基本要素のみで検索する

### 加重スコアリング
- [ ] RRF方式で最終スコアが計算できる
- [ ] 線形結合方式で最終スコアが計算できる
- [ ] ウエイト（α, β, γ）がパラメータで指定できる

### リランキング位置
- [ ] 統合後リランク方式が選択できる
- [ ] 各軸後リランク方式が選択できる
- [ ] リランキングを無効にできる

### プロンプト管理UI
- [ ] 設定画面で材料軸/方法軸/総合軸/重点指示分類の4つのプロンプトが編集できる
- [ ] 保存/復元機能が4つのプロンプトに対応している

### 評価機能
- [ ] 3軸検索パラメータが設定UIから変更できる
- [ ] CSV出力に新しいカラムが追加される
- [ ] 評価履歴に3軸検索設定が記録される

## 成功指標

- 評価機能でnDCGスコアを測定し、現行方式と比較して改善が確認できる
- 材料/方法に特化した検索で、より関連性の高いノートが上位に来る

## スコープ外

以下はこのフェーズでは実装しません:

- チームごとのウエイト永続化（今回はリクエストパラメータで指定）
- 検索軸の追加（材料/方法/総合の3軸固定）
- 検索画面での3軸設定UI（評価画面と設定画面のみ）

## 参照ドキュメント

- `docs/product-requirements.md` - プロダクト要求定義書
- `docs/functional-design.md` - 機能設計書
- `docs/architecture.md` - アーキテクチャ設計書
- `backend/agent.py` - 現行の検索エージェント実装
- `backend/prompts.py` - 現行のプロンプト定義
- `frontend/app/settings/page.tsx` - 設定画面
- `frontend/app/evaluate/page.tsx` - 評価画面
