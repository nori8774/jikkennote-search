# 設計書

## アーキテクチャ概要

現行の単一クエリ検索を3軸分離検索に拡張する。LangGraphのワークフローを変更し、並列検索と結果統合を実現する。

**v3.1.1追加: セクション別Embeddingアーキテクチャ**

各軸が対応するセクションのみを検索対象とすることで、検索精度を向上させる。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    セクション別Embedding + 3軸分離検索                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【取り込み時】                                                              │
│                                                                             │
│  実験ノート.md                                                              │
│       │                                                                     │
│       ├──▶ 材料セクション ──▶ Embedding ──▶ materials_collection           │
│       ├──▶ 方法セクション ──▶ Embedding ──▶ methods_collection             │
│       └──▶ ノート全体    ──▶ Embedding ──▶ combined_collection             │
│                                                                             │
│  【検索時】                                                                  │
│                                                                             │
│  材料軸クエリ ──▶ materials_collection ──▶ 材料軸結果                       │
│  方法軸クエリ ──▶ methods_collection   ──▶ 方法軸結果                       │
│  総合軸クエリ ──▶ combined_collection  ──▶ 総合軸結果                       │
│       │                  │                    │                             │
│       └──────────────────┴────────────────────┘                             │
│                          │                                                  │
│                          ▼                                                  │
│                   スコア統合（RRF/線形結合）                                 │
│                          │                                                  │
│                          ▼                                                  │
│                   最終ランキング                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 検索フロー詳細

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           3軸分離検索フロー                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [入力] 目的, 材料, 方法, 重点指示                                          │
│           │                                                                 │
│           ▼                                                                 │
│  ┌─────────────────┐                                                       │
│  │ 正規化ノード     │                                                       │
│  └────────┬────────┘                                                       │
│           │                                                                 │
│           ▼                                                                 │
│  ┌─────────────────┐                                                       │
│  │ 重点指示分類     │ LLMで「材料/方法/両方/なし」を判定                    │
│  └────────┬────────┘                                                       │
│           │                                                                 │
│           ├──────────────────┬──────────────────┐                          │
│           ▼                  ▼                  ▼                          │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐              │
│  │ 材料軸検索       │ │ 方法軸検索       │ │ 総合軸検索       │              │
│  │ materials_coll  │ │ methods_coll    │ │ combined_coll   │              │
│  └────────┬────────┘ └────────┬────────┘ └────────┬────────┘              │
│           │                  │                  │                          │
│           │  [リランク位置: 各軸後の場合]                                   │
│           ▼                  ▼                  ▼                          │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐              │
│  │ リランク(材料)   │ │ リランク(方法)   │ │ リランク(総合)   │              │
│  └────────┬────────┘ └────────┬────────┘ └────────┬────────┘              │
│           │                  │                  │                          │
│           └──────────────────┼──────────────────┘                          │
│                              ▼                                              │
│                    ┌─────────────────┐                                     │
│                    │ スコア統合       │ RRF or 線形結合                     │
│                    └────────┬────────┘                                     │
│                             │                                              │
│                             │  [リランク位置: 統合後の場合]                 │
│                             ▼                                              │
│                    ┌─────────────────┐                                     │
│                    │ リランク(統合)   │                                     │
│                    └────────┬────────┘                                     │
│                             │                                              │
│                             ▼                                              │
│                    ┌─────────────────┐                                     │
│                    │ 結果返却         │                                     │
│                    └─────────────────┘                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## コンポーネント設計

### 1. ChromaDB構造（v3.1.1変更）

**3つのコレクション**:

| コレクション名 | 内容 | 検索対象 |
|---------------|------|---------|
| `materials_collection` | 各ノートの材料セクション | 材料軸検索 |
| `methods_collection` | 各ノートの方法セクション | 方法軸検索 |
| `combined_collection` | ノート全体 | 総合軸検索 |

**メタデータ**:
- `note_id`: ノートID（例: "ID3-14"）
- `section_type`: "materials" | "methods" | "combined"
- `source_file`: 元ファイル名

### 2. 取り込み処理（v3.1.1変更）

**ingest.py の変更**:

```python
def ingest_note(note_path):
    # ノートを読み込み
    content = read_markdown(note_path)

    # セクションを抽出
    sections = extract_sections(content)

    # 各コレクションに登録
    materials_collection.add(
        documents=[sections["materials"]],
        metadatas=[{"note_id": note_id, "section_type": "materials"}]
    )

    methods_collection.add(
        documents=[sections["methods"]],
        metadatas=[{"note_id": note_id, "section_type": "methods"}]
    )

    combined_collection.add(
        documents=[content],  # ノート全体
        metadatas=[{"note_id": note_id, "section_type": "combined"}]
    )
```

**セクション抽出ルール**:
- `## 材料` または `## Materials` セクションを材料として抽出
- `## 方法` または `## Methods` セクションを方法として抽出
- セクションが見つからない場合は空文字列（検索対象外）

### 3. 検索処理（v3.1.1変更）

**agent.py の変更**:

```python
def _multi_axis_search_node(self, state):
    # 材料軸: materials_collectionを検索
    material_results = self.materials_vectorstore.similarity_search(
        state["material_query"]
    )

    # 方法軸: methods_collectionを検索
    method_results = self.methods_vectorstore.similarity_search(
        state["method_query"]
    )

    # 総合軸: combined_collectionを検索
    combined_results = self.combined_vectorstore.similarity_search(
        state["combined_query"]
    )

    return {
        "material_axis_results": material_results,
        "method_axis_results": method_results,
        "combined_axis_results": combined_results
    }
```

### 4. FocusClassifierノード（既存）

**責務**:
- 重点指示をLLMで解析
- 「materials」「methods」「both」「none」のいずれかを判定
- 判定結果をstateに保存

**実装の要点**:
- 軽量モデル（gpt-4o-mini）を使用してコストを抑える
- JSON形式で結果を返却
- 判定に失敗した場合は「both」にフォールバック

### 5. ScoreFusionノード（既存）

**責務**:
- 各軸の検索結果を統合
- RRF or 線形結合でスコア計算
- 最終ランキングを生成

**実装の要点**:
- RRF: `score = Σ (weight_i / (k + rank_i))` (k=60がデフォルト)
- 線形結合: `score = α×材料スコア + β×方法スコア + γ×総合スコア`
- 重複ドキュメントは最高スコアを採用
- **note_idで結果をマージ**（各コレクションからは同じノートが1件ずつ返る）

### 6. RerankNodeの拡張（既存）

**責務**:
- リランキングの実行
- 位置設定（各軸後 or 統合後）に対応

**実装の要点**:
- rerank_position: "per_axis" | "after_fusion"
- rerank_enabled: true | false

## データフロー

### 取り込みリクエスト（v3.1.1変更）
```
1. ノートファイルを読み込み
2. セクションを抽出（材料/方法/全体）
3. 各コレクションにEmbeddingして登録
   - materials_collection: 材料セクション
   - methods_collection: 方法セクション
   - combined_collection: ノート全体
4. GCSに同期（本番環境）
```

### 検索リクエスト
```
1. クライアントからリクエスト受信
2. 正規化ノードで材料名を正規化
3. 重点指示分類ノードでLLM判定
4. 3軸分離検索（各コレクションを検索）
   - 材料軸: materials_collection を材料クエリで検索
   - 方法軸: methods_collection を方法クエリで検索
   - 総合軸: combined_collection を総合クエリで検索
5. リランキング（位置設定に応じて）
6. スコア統合（note_idでマージ）
7. 最終ランキング返却
```

## 後方互換性

### 既存データのマイグレーション

既存のChromaDB（単一コレクション）から新しい3コレクション構造への移行:

1. **ChromaDBリセット**: 既存データを削除
2. **全ノート再取り込み**: 新しい構造で再登録

**注意**: マイグレーションスクリプトは提供しない。再取り込みが推奨される。

### multi_axis_enabled=false の場合

3軸検索が無効の場合は、従来通り `combined_collection` のみを使用する。

## エラーハンドリング戦略

### 重点指示分類の失敗
- LLM応答のパースに失敗した場合は「both」にフォールバック

### 検索軸の失敗
- 1軸が失敗しても他の軸の結果を使用
- 全軸が失敗した場合は空の結果を返却

### セクション抽出の失敗
- セクションが見つからない場合は空文字列
- 空のセクションは検索対象外（結果なし）

## テスト戦略

### ユニットテスト
- セクション抽出のテスト（各パターン）
- 重点指示分類のテスト（各パターン）
- スコア統合のテスト（RRF、線形結合）

### 統合テスト
- 3コレクションへの取り込み確認
- 3軸検索の実行確認
- 評価機能でのnDCG測定

## 依存ライブラリ

新規追加なし（既存ライブラリで実装可能）

## ディレクトリ構造

```
backend/
├── agent.py           # SearchAgentクラスを拡張（3コレクション対応）
├── ingest.py          # 取り込み処理を拡張（セクション別登録）
├── chroma_sync.py     # ChromaDB管理を拡張（3コレクション対応）
└── config.py          # 新規設定パラメータ追加
```

## 実装の順序

1. config.pyにコレクション名の設定を追加
2. chroma_sync.pyを3コレクション対応に更新
3. ingest.pyにセクション抽出・登録処理を追加
4. agent.pyの3軸検索処理を各コレクション対応に更新
5. 動作確認とテスト

## セキュリティ考慮事項

- APIキーは引き続きリクエストパラメータで受け取る
- LLM呼び出しの入力サニタイズは現行通り

## パフォーマンス考慮事項

- 3軸検索は並列実行してレイテンシを抑える
- 重点指示分類は軽量モデルを使用
- リランキングは必要に応じて無効化可能
- **取り込み時間は約3倍**（3コレクションへの登録）

## 将来の拡張性

- フロントエンドUIでのウエイト設定
- チームごとのウエイト永続化
- 検索軸の追加（目的軸など）
- セクション単位でのEmbeddingモデル変更
