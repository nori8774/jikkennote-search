# 要件定義: コア検索機能強化

## 1. 概要

**機能名**: コア検索機能強化（Phase 2）
**作成日**: 2026-01-02
**関連要件**: FR-112（モデル2段階選択）、FR-116（ハイブリッド検索）

## 2. 目的

検索精度とパフォーマンスを向上させる。具体的には：
- 要約生成時間を30秒→10秒に短縮（FR-112）
- 部分検索（材料のみ、方法のみ）での精度向上（FR-116）

## 3. 機能要件

### 3.1 FR-112: モデル2段階選択

**背景**:
- 現在は全処理（正規化、クエリ生成、検索、要約）で同一のLLMモデルを使用
- 要約生成に高性能モデル（gpt-4o）を使用すると30秒以上かかる

**要件**:
- 検索・判定用LLM（`search_llm_model`）と要約生成用LLM（`summary_llm_model`）を分離
- デフォルト値:
  - `search_llm_model`: "gpt-4o-mini"（正規化、クエリ生成、検索に使用）
  - `summary_llm_model`: "gpt-3.5-turbo"（比較ノードの要約生成に使用）
- 設定ページで両方のモデルを選択可能

**期待効果**:
- 要約生成時間: 30秒 → 10秒に短縮
- コスト削減（gpt-3.5-turboはgpt-4oより低コスト）

### 3.2 FR-116: ハイブリッド検索

**背景**:
- 現在のセマンティック検索では、一部フィールドを「なし」にした際にヒット精度が低下
- 固有名詞（材料名など）の検索精度が不十分

**要件**:
- 3つの検索モードを提供:
  - **semantic**: Embeddingベースのセマンティック検索（現行）
  - **keyword**: BM25トークンベースのキーワード検索
  - **hybrid**: セマンティック + キーワードの組み合わせ（推奨）
- パラメータ:
  - `search_mode`: "semantic" | "keyword" | "hybrid"（デフォルト: "semantic"）
  - `hybrid_alpha`: 0.0〜1.0（セマンティックの重み、デフォルト: 0.7）
- 検索ページに検索モード選択ドロップダウンを追加
- 設定ページに`hybrid_alpha`スライダーを追加

**期待効果**:
- 部分検索での精度向上
- 材料名・方法などキーワード重視の検索精度改善
- nDCG@5 ≥ 0.85を達成

## 4. 非機能要件

- 検索レスポンス時間: < 5秒（ハイブリッド検索含む）
- 要約生成時間: < 10秒
- 後方互換性: 既存のAPIパラメータを維持

## 5. 制約事項

- ChromaDB 0.5.23を使用（Chroma Cloudの新APIは使用不可）
- ハイブリッド検索は手動スコア統合で実装
- ローカル環境での動作確認を優先

## 6. 成功基準

- [ ] FR-112: 要約生成時間が30秒→10秒に短縮
- [ ] FR-112: 設定ページでモデル2段階選択が可能
- [ ] FR-116: ハイブリッド検索でnDCG@5 ≥ 0.85を達成
- [ ] FR-116: 部分検索（材料のみ、方法のみ）でも精度向上
- [ ] E2Eテスト（ローカル環境）: 検索モード切り替え
