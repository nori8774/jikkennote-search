# 要件定義: マルチテナント基盤整備

## 機能概要

複数チームが同じアプリを独立して使用できる基盤を構築する。各チームのデータ（ノート、辞書、ChromaDB）を完全に分離し、セキュアなマルチテナント環境を実現する。

## 背景・目的

### v2.0の課題
- シングルテナント構成で複数チームの利用ができない
- データが混在するリスク
- チームごとの独立した運用ができない

### v3.0での改善
- Firebase Authenticationによる認証
- チーム管理機能（作成、招待、参加、脱退）
- GCSストレージのマルチテナント対応（`teams/{team_id}/`）
- ChromaDBのチームごと分離

## 機能要件（FR-109）

### 1. 認証機能
- Googleログイン（Firebase Authentication）
- ログイン/ログアウト
- 認証状態の管理（フロントエンド）
- ID Token検証（バックエンド）

### 2. チーム管理
- チーム作成
- 招待コード発行（7日間有効）
- 招待コードでの参加
- チーム一覧表示
- チームの切り替え
- チームからの脱退（最後のチーム以外）
- チーム削除（警告付き）

### 3. データ分離
- GCS: `teams/{team_id}/`配下に全データ
- ChromaDB: チームごとに独立したコレクション
- API: 全エンドポイントで`X-Team-ID`ヘッダー検証
- チーム間でデータアクセス不可

### 4. 権限管理（PoC仕様）
- 全メンバー同等の編集権限
- チーム管理者の概念なし（将来拡張）

## 非機能要件

### セキュリティ
- チーム間のデータ完全分離
- Firebase ID Tokenの検証
- HTTPS通信必須
- 短いトークン有効期限

### パフォーマンス
- 認証チェック < 100ms
- チーム切り替え < 1秒

### スケーラビリティ
- 最大100チーム対応
- 同時ログインユーザー: 最大10名

## 制約条件

### 技術制約
- Firebase Authentication（Googleログインのみ）
- Firestoreでチーム情報管理
- GCSバケット構造の変更が必要

### データ制約
- 招待コード有効期限: 7日間
- ユーザーは最低1チームに所属必須

## 成功基準

- [ ] 複数ユーザーでGoogleログイン可能
- [ ] チーム作成・招待・参加のフロー完動
- [ ] チームAのユーザーがチームBのデータにアクセス不可
- [ ] 既存のノート検索機能がチームスコープで動作
- [ ] E2Eテスト: マルチテナントシナリオ（2チーム × 2ユーザー）

## エッジケース

### チーム脱退
- 最後のチームからは脱退不可
- 警告: "最後のチームです。チームを削除するか、他のチームに参加してください。"

### チーム削除
- 全データ（ノート、辞書、ChromaDB）を削除
- 確認ダイアログ: "削除すると復旧できません。本当に削除しますか？"

### 招待コード
- 7日間の有効期限
- 期限切れのコードは無効化され、再発行が必要

## リスク

| リスク | 影響 | 対策 |
|--------|------|------|
| Firebase無料枠超過 | 中 | 使用量モニタリング |
| GCS移行時のデータ損失 | 高 | バックアップ取得、段階的移行 |
| 認証トークン漏洩 | 高 | HTTPS必須、短い有効期限 |
| チーム削除の誤操作 | 中 | 確認ダイアログ、将来的に30日猶予 |

## スコープ外（将来拡張）

- チーム管理者・メンバーの権限分離
- チーム使用量制限
- チーム削除後の復旧機能（30日猶予期間）
- アクセス制御の詳細設定

---

**作成日**: 2025-12-31
**対象フェーズ**: Phase 1
**推奨モデル**: Opus
