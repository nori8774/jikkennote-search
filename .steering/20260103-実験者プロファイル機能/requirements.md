# 要件定義: 実験者プロファイル機能

## 背景

実験ノートには以下の特徴がある：

1. **ノートIDに実験者情報が含まれる**
   - ID1-1, ID1-2, ID1-3... → 実験者1のノート群
   - ID2-1, ID2-2, ID2-3... → 実験者2のノート群

2. **実験者ごとに記述規則が異なる**
   - サフィックス: 実験者1は「1,2,3」、実験者2は「A,B,C」
   - 省略形の意味: ①②③が指す材料は実験者ごとに異なる

3. **方法セクションでの省略記法**
   - 「①を添加して」のように省略形で記載
   - 検索時に材料名が含まれないため、方法軸検索の精度が低下

## 目的

実験者ごとの記述規則をプロファイルとして保存し、以下を実現する：

1. 方法セクション内の省略形（①②③等）を材料名に展開
2. 実験者間のサフィックス名寄せを自動化
3. 同じ実験者のノートは一貫した規則で処理

## スコープ

### 対象

- 実験者プロファイルのデータ構造設計
- プロファイル管理モジュール（CRUD）
- 取り込み時の省略形展開処理
- プロファイル管理UI

### 対象外

- 既存ノートの再処理（手動で再取り込みで対応）
- 複数チーム間のプロファイル共有

## 機能要件

### FR-1: 実験者プロファイルのデータ構造

```yaml
# experimenter_profiles.yaml（チームごと）
id_pattern: "^ID(\\d+)-"  # ノートIDから実験者IDを抽出する正規表現

experimenters:
  "1":
    name: "実験者1"
    suffix_conventions:
      - ["1", "A"]
      - ["2", "B"]
    material_shortcuts:
      "①": "HbA1c捕捉抗体1: 1mL"
      "②": "HbA1c検出抗体1: 0.5mL"
    learned_from: "ID1-1"
    created_at: "2026-01-03T10:00:00"
    updated_at: "2026-01-03T10:00:00"
```

### FR-2: 実験者IDの抽出

- ノートIDからid_patternを使って実験者IDを抽出
- 例: "ID2-5" → 実験者ID "2"
- パターンはチームごとに設定可能

### FR-3: プロファイルの自動学習

1. 新しい実験者のノートを取り込む時
2. LLMが材料セクションを解析
3. 省略形（①②③等）と材料の対応を抽出
4. プロファイルに保存

### FR-4: 方法セクションの省略形展開

1. ノート取り込み時に実行
2. プロファイルの`material_shortcuts`を使用
3. 展開後のテキストをmethods_collectionに格納

### FR-5: プロファイル管理UI

- 実験者一覧の表示
- プロファイルの編集（名前、サフィックス規則、省略形）
- プロファイルの削除
- IDパターンの設定

## 非機能要件

### NFR-1: 後方互換性

- プロファイルが未設定の場合は従来通り処理（展開なし）

### NFR-2: パフォーマンス

- LLMによる学習は実験者ごとに1回のみ
- 2回目以降は保存済みプロファイルを再利用

## 成功基準

1. 方法セクションの「①を添加」が「HbA1c捕捉抗体1を添加」に展開される
2. 同じ実験者のノートは同じ規則で処理される
3. 実験者間のサフィックス対応が自動的に設定される
