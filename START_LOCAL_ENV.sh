#!/bin/bash
# сЃГсЃ╝сѓФсЃФжќІуЎ║уњ░тбЃ УхитІЋсѓ╣сѓ»сЃфсЃЌсЃѕ
# СйюТѕљТЌЦ: 2026-01-01

set -e

echo "=========================================="
echo "сЃГсЃ╝сѓФсЃФжќІуЎ║уњ░тбЃсѓњУхитІЋсЂЌсЂЙсЂЎ"
echo "=========================================="
echo ""

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
BACKEND_DIR="$SCRIPT_DIR/backend"
FRONTEND_DIR="$SCRIPT_DIR/frontend"

# тЈцсЂёсЃЌсЃГсѓ╗сѓ╣сѓњтЂюТГб
echo "­ЪД╣ тЈцсЂёсЃЌсЃГсѓ╗сѓ╣сѓњсѓ»сЃфсЃ╝сЃ│сѓбсЃЃсЃЌСИГ..."
lsof -ti:8000 | xargs kill -9 2>/dev/null || true
lsof -ti:3000 | xargs kill -9 2>/dev/null || true
echo "РюЁ сѓ»сЃфсЃ╝сЃ│сѓбсЃЃсЃЌт«їС║є"
echo ""

# сЃљсЃЃсѓ»сѓесЃ│сЃЅсѓњУхитІЋ
echo "­Ъџђ сЃљсЃЃсѓ»сѓесЃ│сЃЅсѓњУхитІЋСИГ..."
cd "$BACKEND_DIR"

# сЃљсЃЃсѓ»сѓесЃ│сЃЅсѓњсЃљсЃЃсѓ»сѓ░сЃЕсѓдсЃ│сЃЅсЂДУхитІЋ
python3 server.py > /tmp/backend.log 2>&1 &
BACKEND_PID=$!

echo "   сЃљсЃЃсѓ»сѓесЃ│сЃЅPID: $BACKEND_PID"
echo "   сЃГсѓ░сЃЋсѓАсѓцсЃФ: /tmp/backend.log"
echo ""

# сЃљсЃЃсѓ»сѓесЃ│сЃЅсЂ«УхитІЋсѓњтЙЁсЂц
echo "РЈ│ сЃљсЃЃсѓ»сѓесЃ│сЃЅсЂ«УхитІЋсѓњтЙЁсЂБсЂдсЂёсЂЙсЂЎ..."
for i in {1..30}; do
    if curl -s http://localhost:8000/health > /dev/null 2>&1; then
        echo "РюЁ сЃљсЃЃсѓ»сѓесЃ│сЃЅсЂїУхитІЋсЂЌсЂЙсЂЌсЂЪ (http://localhost:8000)"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "РЮї сЃљсЃЃсѓ»сѓесЃ│сЃЅсЂ«УхитІЋсЂїсѓ┐сѓцсЃасѓбсѓдсЃѕсЂЌсЂЙсЂЌсЂЪ"
        echo "сЃГсѓ░сѓњуб║УфЇсЂЌсЂдсЂЈсЂасЂЋсЂё: tail -f /tmp/backend.log"
        exit 1
    fi
    sleep 1
done
echo ""

# сЃЋсЃГсЃ│сЃѕсѓесЃ│сЃЅсѓњУхитІЋ
echo "­Ъџђ сЃЋсЃГсЃ│сЃѕсѓесЃ│сЃЅсѓњУхитІЋСИГ..."
cd "$FRONTEND_DIR"

# сЃЋсЃГсЃ│сЃѕсѓесЃ│сЃЅсѓњсЃЋсѓЕсѓбсѓ░сЃЕсѓдсЃ│сЃЅсЂДУхитІЋ
echo "   URL: http://localhost:3000"
echo ""
echo "=========================================="
echo "РюЁ УхитІЋт«їС║є"
echo "=========================================="
echo ""
echo "­ЪЊЮ жќІуЎ║сЃАсЃб:"
echo "  - сЃЋсЃГсЃ│сЃѕсѓесЃ│сЃЅ: http://localhost:3000"
echo "  - сЃљсЃЃсѓ»сѓесЃ│сЃЅ: http://localhost:8000"
echo "  - сЃљсЃЃсѓ»сѓесЃ│сЃЅсЃГсѓ░: tail -f /tmp/backend.log"
echo ""
echo "­ЪЏЉ тЂюТГбТќ╣Т│Ћ:"
echo "  - Ctrl+C сЂДсЃЋсЃГсЃ│сЃѕсѓесЃ│сЃЅсѓњтЂюТГб"
echo "  - kill $BACKEND_PID сЂДсЃљсЃЃсѓ»сѓесЃ│сЃЅсѓњтЂюТГб"
echo ""

npm run dev
