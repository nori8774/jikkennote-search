# 実験ノート検索システム v2.0 - ユーザーマニュアル

## 目次

1. [はじめに](#はじめに)
2. [システムの起動](#システムの起動)
3. [初期設定](#初期設定)
4. [実験ノートの管理](#実験ノートの管理)
5. [検索機能](#検索機能)
6. [正規化辞書の管理](#正規化辞書の管理)
7. [検索履歴](#検索履歴)
8. [RAG性能評価](#rag性能評価)
9. [よくある質問](#よくある質問)
10. [トラブルシューティング](#トラブルシューティング)

---

## はじめに

### システム概要

実験ノート検索システム v2.0 は、LangChainとRAG（Retrieval-Augmented Generation）技術を活用した高精度な実験ノート検索システムです。

### 主な機能

1. **セマンティック検索**: 意味ベースで関連する実験ノートを検索
2. **比較分析レポート**: LLMによる詳細な分析レポート生成
3. **正規化辞書管理**: 化学物質の表記揺れを統一
4. **検索履歴**: 過去の検索を保存・再利用
5. **RAG性能評価**: システムの検索精度を定量的に評価

### 対応ブラウザ

- Google Chrome（推奨）
- Mozilla Firefox
- Microsoft Edge
- Safari

---

## システムの起動

### ローカル環境

#### バックエンドの起動

```bash
cd backend
source .venv/bin/activate  # Windows: .venv\Scripts\activate
python server.py
```

サーバーは http://localhost:8000 で起動します。

#### フロントエンドの起動

```bash
cd frontend
npm run dev
```

UIは http://localhost:3000 で起動します。

### 本番環境

デプロイ済みのURLにアクセス:
- フロントエンド: `https://your-app.vercel.app`
- バックエンド: `https://your-backend.railway.app`

---

## 初期設定

### 1. APIキーの設定

システムを使用するには、以下のAPIキーが必要です：

1. **OpenAI API Key**
   - 取得方法: https://platform.openai.com/api-keys
   - 用途: Embedding生成、LLMによる分析

2. **Cohere API Key**
   - 取得方法: https://dashboard.cohere.com/api-keys
   - 用途: 検索結果のReranking

#### 設定手順

1. ホーム画面から「設定」をクリック
2. 「APIキー」タブを選択
3. OpenAI API Keyを入力
4. Cohere API Keyを入力
5. 「設定を保存」ボタンをクリック

**重要**: APIキーはブラウザのlocalStorageに保存されます。サーバーには送信されません。

### 2. モデルの選択

#### Embeddingモデル

| モデル | 次元数 | 特徴 | 推奨用途 |
|--------|--------|------|----------|
| text-embedding-3-small | 1536 | 軽量・高速 | デフォルト |
| text-embedding-3-large | 3072 | 高精度 | 精度重視 |
| text-embedding-ada-002 | 1536 | 旧モデル | 互換性 |

#### LLMモデル

| モデル | コンテキスト | 特徴 | 推奨用途 |
|--------|------------|------|----------|
| gpt-4o-mini | 128K | 高速・低コスト | デフォルト |
| gpt-4o | 128K | 高性能 | 精度重視 |
| gpt-4-turbo | 128K | バランス型 | 汎用 |
| gpt-3.5-turbo | 16K | 低コスト | コスト重視 |

#### 設定手順

1. 設定画面の「モデル選択」タブを選択
2. Embeddingモデルを選択
3. LLMモデルを選択
4. 「設定を保存」ボタンをクリック

### 3. プロンプトのカスタマイズ（オプション）

システムのプロンプトをカスタマイズできます：

1. 設定画面の「プロンプト管理」タブを選択
2. 各プロンプトを編集
3. 初期設定に戻す場合は「リセット」ボタン
4. 「設定を保存」ボタンをクリック

---

## 実験ノートの管理

### ノートの準備

#### Markdown形式

実験ノートはMarkdown形式（.md）で作成します。

**推奨フォーマット**:

```markdown
# 実験ノート ID3-14

## 目的・背景
ポリマーAとポリマーBの混合物を合成し、その物性を評価する。

## 材料
- ポリマーA: 10g
- ポリマーB: 5g
- トルエン: 100ml
- 触媒X: 0.5g

## 方法
1. フラスコにポリマーAとポリマーBを投入
2. トルエンを加えて溶解
3. 触媒Xを添加
4. 80℃で2時間加熱
5. 冷却後、沈殿物を濾過

## 結果
白色の固体が得られた。収率: 85%
融点: 180-182℃

## 考察
予想通りの物性が得られた。
```

**セクション名の推奨**:
- 目的・背景 / 目的 / Background
- 材料 / Materials
- 方法 / Methods / 手順 / Procedure
- 結果 / Results
- 考察 / Discussion

### ノートの取り込み

#### 1. ファイルの配置

ノートファイルをバックエンドサーバーの指定フォルダに配置：
- デフォルト: `backend/notes/new/`

#### 2. 取り込み実行

1. ホーム画面から「ノート管理」をクリック
2. ソースフォルダを確認（空欄の場合はデフォルト）
3. 取り込み後のアクションを選択：
   - **ファイルを残す**: そのまま保持
   - **アーカイブフォルダへ移動**: `notes/archived/` へ移動
   - **ファイルを削除**: 取り込み後に削除
4. 「取り込み実行」ボタンをクリック

#### 3. 新出単語の判定

取り込み時に新しい化学物質が検出された場合、判定画面が表示されます。

**判定オプション**:
- **新規物質**: 新しい化学物質として辞書に追加
- **表記揺れ**: 既存物質の別名として追加
- **スキップ**: 辞書に追加しない

**LLM推奨の確認**:
- システムがLLMを使用して自動判定
- 推奨に従うか、手動で変更可能

#### 4. 辞書の更新

判定を確認したら「辞書を更新」ボタンをクリックして完了。

---

## 検索機能

### 基本的な検索

#### 1. 検索条件の入力

検索画面で以下を入力：

- **目的**: 実験の目的（例: 「ポリマーの合成」）
- **材料**: 使用する材料（例: 「ポリマーA、トルエン」）
- **方法**: 実験方法（例: 「加熱、混合」）
- **重点指示**（オプション）: 特に注目したいポイント

#### 2. 検索実行

「検索」ボタンをクリックして検索を実行。

#### 3. 検索結果の確認

**比較分析レポート**:
- LLMによる詳細な分析
- 類似点と相違点
- 推奨事項

**上位3件のノート**:
- 関連度の高い順に表示
- ノートID、スコア、セクション別内容

### 検索結果の活用

#### 材料・方法のコピー

各ノートには「材料をコピー」「方法をコピー」ボタンがあります。

1. ボタンをクリック
2. 検索条件欄に自動的に反映
3. 条件を調整して再検索

#### ノートIDのクリック

ノートIDをクリックすると、ビューワーでノート全体を表示。

### 検索のコツ

**高精度な検索のために**:
1. 具体的なキーワードを使用
2. 複数の条件を組み合わせる
3. 材料名は正規化辞書に登録されている名前を使用
4. 重点指示で検索の焦点を明確にする

**例**:
```
目的: ナイロン6,6の合成
材料: ヘキサメチレンジアミン、アジピン酸
方法: 界面重合
重点指示: 収率を最大化する方法
```

---

## 正規化辞書の管理

### 辞書の役割

正規化辞書は化学物質の表記揺れを統一します。

**例**:
- 正規化名: `ヘキサメチレンジアミン`
- 表記揺れ: `HMDA`, `1,6-ヘキサンジアミン`, `hexamethylenediamine`

### 辞書の閲覧

1. ホーム画面から「辞書管理」をクリック
2. エントリ一覧が表示されます：
   - 正規化名
   - 表記揺れのリスト
   - カテゴリ（試薬、溶媒、触媒など）
3. 検索ボックスでフィルタリング可能

### 辞書のエクスポート

**対応形式**:
- YAML（推奨）
- JSON
- CSV

**手順**:
1. 「YAML出力」「JSON出力」「CSV出力」ボタンをクリック
2. ファイルがダウンロードされます

**ファイル形式**:

YAML:
```yaml
- canonical: ヘキサメチレンジアミン
  variants:
    - HMDA
    - 1,6-ヘキサンジアミン
  category: 試薬
```

JSON:
```json
[
  {
    "canonical": "ヘキサメチレンジアミン",
    "variants": ["HMDA", "1,6-ヘキサンジアミン"],
    "category": "試薬"
  }
]
```

CSV:
```csv
canonical,variants,category
ヘキサメチレンジアミン,"HMDA,1,6-ヘキサンジアミン",試薬
```

### 辞書のインポート

1. 「インポート」ボタンをクリック
2. YAML/JSON/CSVファイルを選択
3. 自動的に辞書が更新されます

**注意**:
- 既存のエントリは上書きされます
- バックアップを取ることを推奨

### 辞書の手動編集

1. 辞書管理画面でエントリを確認
2. `master_dictionary.yaml` を直接編集
3. システムを再起動して反映

---

## 検索履歴

### 履歴の確認

1. 検索画面の「履歴」タブをクリック
2. 過去の検索履歴がテーブル表示されます：
   - 検索日時
   - 目的
   - 材料
   - 方法
   - 上位3件のノートID

### 履歴の再利用

1. 履歴テーブルの行をクリック
2. 検索条件が自動的に入力されます
3. そのまま再検索、または条件を調整

### 履歴の削除

1. 削除したい履歴の「削除」ボタンをクリック
2. 確認ダイアログで「OK」

**注意**: 履歴は最新100件まで保存されます。

---

## RAG性能評価

### 評価の目的

システムの検索精度を定量的に評価します。

**評価指標**:
- **nDCG@10**: 正規化割引累積利得（上位10件）
- **Precision@K**: 適合率（上位K件）
- **Recall@K**: 再現率（上位K件）
- **MRR**: 平均逆順位

### テストケースの準備

#### CSV形式

```csv
test_case_id,test_case_name,purpose,materials,methods,note_id,rank,relevance
TC001,テストケース1,ポリマー合成,ポリマーA,加熱,ID3-14,1,5
TC001,テストケース1,ポリマー合成,ポリマーA,加熱,ID3-15,2,4
TC001,テストケース1,ポリマー合成,ポリマーA,加熱,ID3-16,3,3
```

**カラムの説明**:
- `test_case_id`: テストケースID（同じIDで複数行）
- `test_case_name`: テストケース名
- `purpose`: 検索目的
- `materials`: 検索材料
- `methods`: 検索方法
- `note_id`: 期待されるノートID
- `rank`: 期待される順位
- `relevance`: 関連度スコア（1-5）

#### Excel形式

CSVと同じ形式で、`.xlsx` ファイルとして保存。

### 評価の実行

1. 評価ページにアクセス
2. 「テストケースをインポート」ボタンをクリック
3. CSV/Excelファイルを選択
4. インポートされたテストケースを確認
5. 「評価を実行」ボタンをクリック

### 評価結果の確認

**個別評価**:
- テストケースごとの評価結果
- nDCG@10, Precision@3, Recall@3, MRR

**バッチ評価**:
- 全テストケースの平均スコア
- システム全体の性能指標

### 結果の活用

評価結果を基に:
1. プロンプトの調整
2. Embeddingモデルの変更
3. 正規化辞書の更新
4. テストケースの追加

---

## よくある質問

### Q1: APIキーはどこに保存されますか？

A: ブラウザのlocalStorageに保存されます。サーバーには送信されません。

### Q2: 検索結果が0件の場合は？

A: 以下を確認してください：
1. ノートが取り込まれているか
2. 検索条件が厳しすぎないか
3. 材料名が正規化辞書に登録されているか

### Q3: 辞書の表記揺れはどう判定されますか？

A: LLMを使用して自動判定されます。ユーザーが最終決定できます。

### Q4: 検索履歴は何件まで保存されますか？

A: 最新100件まで自動的に保存されます。

### Q5: 本番環境でファイルをアップロードするには？

A: SSH経由でサーバーにアクセスし、`/app/notes/new/` ディレクトリにファイルを配置してください。

### Q6: プロンプトをカスタマイズすると何が変わりますか？

A: LLMの応答内容や検索の挙動が変わります。初期設定に戻すことも可能です。

### Q7: Embeddingモデルを変更すると既存のデータはどうなりますか？

A: モデル変更後はノートを再取り込みする必要があります。

---

## トラブルシューティング

### 検索が遅い

**原因**: 重いモデルを使用している

**解決策**:
1. Embeddingモデルを `text-embedding-3-small` に変更
2. LLMモデルを `gpt-4o-mini` に変更

### ノート取り込みでエラーが出る

**原因**: ファイル形式またはパスの問題

**解決策**:
1. Markdown形式（.md）であることを確認
2. ファイル名に特殊文字が含まれていないか確認
3. ソースフォルダのパスが正しいか確認

### 辞書インポートが失敗する

**原因**: ファイル形式の誤り

**解決策**:
1. YAML/JSON/CSVの形式が正しいか確認
2. UTF-8エンコーディングであることを確認
3. ファイルサイズが大きすぎないか確認（推奨: 1MB未満）

### CORS エラーが出る

**原因**: フロントエンドとバックエンドのドメイン不一致

**解決策**:
1. バックエンドのCORS設定を確認
2. 環境変数 `CORS_ORIGINS` にフロントエンドのURLが含まれているか確認

### APIキーが保存されない

**原因**: ブラウザのlocalStorageが無効

**解決策**:
1. ブラウザの設定でlocalStorageを有効にする
2. プライベートモードを使用していないか確認

---

## サポート

その他の問題やご質問がある場合は、以下をご確認ください：

1. README.md のトラブルシューティングセクション
2. DEPLOYMENT.md のトラブルシューティングセクション
3. GitHubのIssuesで報告

**問い合わせ時の情報**:
- エラーメッセージ全文
- 実行した操作手順
- 環境情報（OS、ブラウザ、Python/Nodeバージョン）
- バックエンドのログ出力

---

## 付録: キーボードショートカット

現在のバージョンではキーボードショートカットは実装されていません。今後のアップデートで追加予定です。

---

## 付録: 用語集

- **RAG**: Retrieval-Augmented Generation - 検索拡張生成
- **Embedding**: テキストをベクトル化したもの
- **Reranking**: 検索結果の再順位付け
- **nDCG**: Normalized Discounted Cumulative Gain - 正規化割引累積利得
- **MRR**: Mean Reciprocal Rank - 平均逆順位
- **CORS**: Cross-Origin Resource Sharing - オリジン間リソース共有

---

**バージョン**: v2.0.4
**最終更新**: 2025-12-19
